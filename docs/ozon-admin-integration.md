# Интеграция Ozon в админке (CMS)

Этот документ описывает новый раздел админки для работы с товарами из Ozon: поиск, просмотр, сопоставление и импорт/обновление в локальный каталог.

## Что нового (обновление 2025‑08‑19)

- Новый раздел `/dashboard/ozon` с постраничной загрузкой (по 30 шт.) и кнопкой «Показать ещё».
- Реальные эндпоинты Ozon: `POST /v3/product/list`, `POST /v3/product/info/list`, с фолбэком на `POST /v4/product/info/attributes` для характеристик.
- Корректная вытяжка OEM и бренда:
  - OEM приоритетно из атрибута id `7236`.
  - Бренд приоритетно из атрибутов id `85` и `5076`, затем по имени характеристики.
- Импорт: сохраняем до 8 изображений в S3, переносим описание, габариты (мм→см), вес (g→kg), характеристики не переносим (оставляем пустыми), артикул (OEM) пишем в `article`, бренд пишем в `brand`.
- Уведомления: используем общий проектный `react-hot-toast` (топ‑право), плюс короткое inline‑сообщение под строкой поиска.
- Исправления:
  - `product_id` Ozon обрабатывается как строка (исключена потеря точности для int64).
  - В GraphQL‑запрос `GET_PRODUCTS` добавлено поле `brand`, чтобы бренд показывался в карточке товара после импорта.

## Обзор

- Раздел: `/dashboard/ozon` (пункт «Ozon» в боковом меню).
- Что видно: список товаров из вашего кабинета Ozon (по умолчанию — постранично), бренд, OEM, цена и главное фото.
- Что можно: выбрать товары и импортировать как новые или обновить существующие по совпадению артикула (OEM → `article` в БД).

## Настройка

В `protekauto-cms/.env` добавьте:

- `OZON_CLIENT_ID=<ваш Client-Id>`
- `OZON_API_KEY=<ваш Api-Key>`
- (опционально) `OZON_MOCK=1` — включает мок-данные для разработки без реального API.

Для хранения изображений используются уже существующие S3‑переменные (`AWS_*`, `S3_ENDPOINT`, `AWS_S3_BUCKET`).

## Как работает

### Загрузка и пагинация

- Список товаров подгружается страницами по 30 позиций (регулируется параметром `limit`).
- Используется `POST /v3/product/list` (фильтр по `visibility: ALL`) с параметрами `limit` и `last_id` для постраничной навигации.
- Кнопка «Показать ещё» запрашивает следующую страницу (`last_id` из предыдущего ответа).

### Обогащение данных

- Детальная информация запрашивается батчем через `POST /v3/product/info/list` (по `product_id[]`).
- Если в ответе нет характеристик, выполняется дополнительный запрос `POST /v4/product/info/attributes` (с `filter.product_id[]`), чтобы гарантированно получить характеристики.

### Уведомления (Toaster)

- Используем общий провайдер `react-hot-toast` (подключён в `src/components/providers/ToastProvider.tsx` и `src/app/layout.tsx`).
- На странице Ozon тосты показываются при:
  - ошибке поиска и подгрузки,
  - успехе/ошибке импорта.
- Тосты закрываются автоматически через ~3.5 сек и доступны к закрытию вручную.

### Отображаемые поля

- Фото: показывается главное изображение (берём из `images` или `primary_image`).
- Бренд: извлекается из характеристики с id `85` (Brand). Для некоторых категорий возможен id `5076`. Если числовые ID недоступны — ищется по именам характеристик: «Бренд», «Производитель», «Марка», «Brand», «Manufacturer» и их вариациям (по данным `description-category/attribute`).
- OEM (артикул производителя):
  - приоритетно — характеристика с id `7236` (например, `SILZKR7B11`),
  - затем — по названию характеристики: «Артикул производителя», «Номер производителя», «OEM/ОЕМ», «MPN/Part Number», «Номер детали», «Каталожный номер», «ОЕМ номер», «Оригинальный номер», «Код производителя»,
  - затем — распознавание «кодоподобного» значения среди других характеристик (исключая бренд/название),
  - в самом крайнем случае — `offer_id`.
- Цена: берётся из `price`, при отсутствии — `marketing_price`, затем — `old_price`.

## Импорт и обновление

- Массовые действия доступны в шапке таблицы: «Импортировать как новые» и «Обновить по совпадению артикула».
- Сопоставление: локальный товар ищется по `article` = OEM; если найден, выполняется обновление, иначе можно создать новый.
- Сохранение изображений: при импорте сохраняется несколько изображений (до 8) в ваш S3 (папка `products/`), доступ по публичной ссылке. Порядок сохраняется.
- Характеристики: при импорте не переносятся из Ozon (оставляются пустыми по требованиям). При обновлении существующего товара старые характеристики очищаются.
- Описание: забирается из атрибутов Ozon (приоритетно id `4191`, затем `4180`), при отсутствии — из данных ответа поиска.
- Габариты и вес: берутся из `v4/product/info/attributes` (height/depth/width и их единицы, weight и единицы). Преобразование: мм → см, вес граммы → кг. Сохраняются в `dimensions` (строка «ДxШxВ, см») и `weight` (кг).

## API (внутренние роуты админки)

- `GET /api/ozon/search?limit=30&last_id=...&q=...`
  - Возвращает `{ items, last_id, total }` для рендера страницы.
  - Параметры:
    - `limit` — кол-во товаров на страницу (1..100, по умолчанию 30),
    - `last_id` — курсор пагинации (из прошлого ответа),
    - `q` — строка поиска по OEM/названию/характеристикам (фильтрует текущую страницу).

- `POST /api/ozon/match`
  - Тело: `{ articles: string[] }`
  - Ответ: `{ matches: { [article]: { id, name } } }` — сопоставление OEM → локальный товар.

- `POST /api/ozon/import`
  - Тело: `{ items: [{ id, name, brand?, oem?, price?, images[], attributes?, mode: 'new' | 'update' | 'auto' }] }`
  - Импортирует товары: создаёт новые либо обновляет существующие по совпадению `article` (OEM).
  - При обновлении изображения перезаписываются, характеристики заменяются на новые значения.

## Ограничения и производительность

- Для скорости данные подгружаются страницами, а детальная информация — батчами.
- Если категорий много и названия характеристик редко совпадают, добавляйте известные `attribute_id` в список: бренд (85), OEM (7236). При необходимости можно расширить список под ваши категории.

## Траблшутинг

- Пустые бренд/OEM: проверьте, есть ли у товара характеристики в ответе `info/list`. Если нет — они будут подмешаны из ответа `product/info/attributes`. Если и там нет — пришлите `product_id`, чтобы добавить конкретный `attribute_id` в правила.
- Медленная загрузка: проверьте, что используете пагинацию (кнопка «Показать ещё»), и не выставлен слишком большой `limit`.
- Неправильный OEM: проверьте значение id `7236` и названия OEM‑характеристик для конкретной категории, возможно нужно добавить id в список.

## Безопасность

- Ключи `OZON_CLIENT_ID` и `OZON_API_KEY` хранятся в переменных окружения CMS и используются только на серверной стороне роутов.
